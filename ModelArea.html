<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Viral Dose Models — Admin</title>

  <!-- Tailwind + fonts + icons -->
  <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;800&display=swap" rel="stylesheet"/>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet"/>

  <!-- Charts & Signature -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.0.0/dist/signature_pad.umd.min.js"></script>
  <!-- FIX: Added jsPDF library for on-demand PDF generation -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <style>
    :root { --vdm-yellow:#FFE500; --sidebar-w:16rem; }
    body { font-family: Inter, system-ui, sans-serif; }
    body.sidebar-collapsed { --sidebar-w:5rem; }
    .glass { background: rgba(20,20,25,.55); backdrop-filter: blur(16px); border:1px solid rgba(255,255,255,.08); }
    .btn-main { background:var(--vdm-yellow); color:#101013; }
    .hover-float { transform: translateY(0); transition: transform .3s ease, box-shadow .3s ease; }
    .hover-float:hover { transform: translateY(-6px); box-shadow: 0 18px 40px rgba(0,0,0,.35); }
    #sidebar { width: var(--sidebar-w); transition: width .3s ease-in-out; }
    #main { margin-left: calc(var(--sidebar-w) + 1.25rem); transition: margin-left .3s ease-in-out; }
    .nav-active { background-color: rgba(255,255,255,.07); color:#fff; }
    .sidebar-text {
      opacity: 1;
      width: auto;
      transition: opacity .2s ease .1s, width .2s ease .1s;
      white-space: nowrap;
      overflow: hidden;
    }
    body.sidebar-collapsed .sidebar-text {
      opacity: 0;
      width: 0;
      transition: opacity .1s ease, width .2s ease;
    }
    #adminPad {
        background-color: #ffffff;
        border-radius: 0.75rem; /* rounded-xl */
    }
  </style>
</head>
<body class="min-h-screen bg-[radial-gradient(1200px_800px_at_20%_-10%,#3b3b45_0%,#121217_40%,#0b0b0f_100%)] text-gray-100 sidebar-collapsed">

  <div class="flex h-screen overflow-hidden">
    <!-- Sidebar -->
    <aside id="sidebar" class="glass fixed inset-y-4 left-4 rounded-2xl p-3 flex flex-col z-20">
      <div class="flex items-center gap-3 px-3 py-2">
        <div class="w-10 h-10 grid place-items-center rounded-xl flex-shrink-0"
             style="background:rgba(255,229,0,.12); border:1px solid rgba(255,229,0,.35)">
          <span class="material-icons text-[var(--vdm-yellow)]">bolt</span>
        </div>
        <div class="text-sm font-bold sidebar-text">Viral Dose Models</div>
      </div>

      <nav class="mt-2 space-y-2 flex-1 px-2">
        <a href="#" class="nav-link flex items-center gap-3 px-3 py-3 rounded-xl text-gray-300 hover:text-white hover:bg-white/5 nav-active"
           data-target="dashboard-page">
          <span class="material-icons">dashboard</span><span class="sidebar-text">Dashboard</span>
        </a>
        <a href="#" class="nav-link flex items-center gap-3 px-3 py-3 rounded-xl text-gray-300 hover:text-white hover:bg-white/5"
           data-target="models-page">
          <span class="material-icons">groups</span><span class="sidebar-text">Models</span>
        </a>
        <a href="#" class="nav-link flex items-center gap-3 px-3 py-3 rounded-xl text-gray-300 hover:text-white hover:bg-white/5"
           data-target="contracts-page">
          <span class="material-icons">gavel</span><span class="sidebar-text">Contracts</span>
        </a>
      </nav>

      <div class="mt-auto px-2 pb-2">
        <div class="flex items-center gap-3 px-3 py-2">
          <div class="w-9 h-9 rounded-full bg-white/10 grid place-items-center text-xs flex-shrink-0">ADM</div>
          <div class="sidebar-text text-xs">
            <div class="font-semibold">Admin</div>
            <button id="logout-btn" class="text-gray-400 hover:text-white">Logout</button>
          </div>
        </div>
      </div>
    </aside>

    <!-- Main -->
    <main id="main" class="flex-1 p-4 md:p-6 overflow-y-auto">
      <!-- DASHBOARD -->
      <section id="dashboard-page" class="space-y-4 md:space-y-6">
        <header class="flex flex-wrap items-center justify-between gap-4">
          <div>
            <h1 class="text-2xl md:text-3xl font-extrabold">Dashboard</h1>
            <p class="text-sm text-gray-400">Realtime overview of studio performance</p>
          </div>
          <div class="flex items-center gap-2 md:gap-3">
            <select id="chartType" class="rounded-xl bg-white/5 border border-white/10 px-3 py-2 text-sm focus:ring-2 focus:ring-[var(--vdm-yellow)]">
              <option value="revenue">Revenue</option>
              <option value="profit">Profit</option>
            </select>
            <select id="rangeSelect" class="rounded-xl bg-white/5 border border-white/10 px-3 py-2 text-sm focus:ring-2 focus:ring-[var(--vdm-yellow)]">
              <option value="7">Last 7 days</option>
              <option value="30">Last 30 days</option>
              <option value="365">Last year</option>
              <option value="0">All time</option>
            </select>
          </div>
        </header>

        <!-- Stats -->
        <div class="grid grid-cols-2 lg:grid-cols-4 gap-3 md:gap-4">
          <div class="glass p-4 md:p-5 rounded-2xl hover-float">
            <div class="flex items-center justify-between">
              <div><p class="text-gray-400 text-xs md:text-sm">Revenue</p><p id="statRevenue" class="text-2xl md:text-3xl font-extrabold">$0</p></div>
              <div class="w-10 h-10 md:w-11 md:h-11 grid place-items-center rounded-xl" style="background:rgba(255,229,0,.12); border:1px solid rgba(255,229,0,.35)">
                <span class="material-icons text-[var(--vdm-yellow)]">attach_money</span>
              </div>
            </div>
          </div>
          <div class="glass p-4 md:p-5 rounded-2xl hover-float">
            <div class="flex items-center justify-between">
              <div><p class="text-gray-400 text-xs md:text-sm">Profit</p><p id="statProfit" class="text-2xl md:text-3xl font-extrabold">$0</p></div>
              <div class="w-10 h-10 md:w-11 md:h-11 grid place-items-center rounded-xl bg-white/5 border border-white/10">
                <span class="material-icons">trending_up</span>
              </div>
            </div>
          </div>
          <div class="glass p-4 md:p-5 rounded-2xl hover-float">
            <div class="flex items-center justify-between">
              <div><p class="text-gray-400 text-xs md:text-sm">Total Models</p><p id="statModels" class="text-2xl md:text-3xl font-extrabold">0</p></div>
              <div class="w-10 h-10 md:w-11 md:h-11 grid place-items-center rounded-xl bg-white/5 border border-white/10">
                <span class="material-icons">face_retouching_natural</span>
              </div>
            </div>
          </div>
          <div class="glass p-4 md:p-5 rounded-2xl hover-float">
            <div class="flex items-center justify-between">
              <div><p class="text-gray-400 text-xs md:text-sm">Daily Visitors</p><p id="statVisitors" class="text-2xl md:text-3xl font-extrabold">0</p></div>
              <div class="w-10 h-10 md:w-11 md:h-11 grid place-items-center rounded-xl bg-white/5 border border-white/10">
                <span class="material-icons">people</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Chart & Logs -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-3 md:gap-4">
          <div class="lg:col-span-2 glass p-4 md:p-5 rounded-2xl">
            <div class="flex items-center justify-between mb-2 md:mb-3">
              <h3 id="chartTitle" class="text-lg md:text-xl font-bold">Revenue</h3>
            </div>
            <div id="chartWrap" class="h-56 md:h-64 lg:h-60 xl:h-64">
              <canvas id="mainChart"></canvas>
            </div>
          </div>
          <div class="glass p-4 md:p-5 rounded-2xl">
            <h3 class="text-lg md:text-xl font-bold mb-2 md:mb-3">Logs</h3>
            <div id="logs" class="space-y-3 max-h-56 md:max-h-64 overflow-y-auto pr-2"></div>
          </div>
        </div>
      </section>

      <!-- MODELS -->
      <section id="models-page" class="hidden space-y-4 md:space-y-6">
        <div class="flex flex-wrap items-center justify-between gap-4">
          <h2 class="text-2xl md:text-3xl font-extrabold">Models</h2>
          <div class="flex items-center gap-3">
            <div class="relative">
              <input id="searchModel" placeholder="Search by name…"
                     class="rounded-xl bg-white/5 border border-white/10 pl-10 pr-3 py-2 text-sm"/>
              <span class="material-icons absolute left-2 top-1/2 -translate-y-1/2 text-gray-400">search</span>
            </div>
            <button id="addModelBtn" class="btn-main px-4 py-2 rounded-xl font-bold">Add New Model</button>
          </div>
        </div>

        <!-- Cards -->
        <div id="modelGrid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4"></div>
      </section>

      <!-- CONTRACTS -->
      <section id="contracts-page" class="hidden space-y-4 md:space-y-6">
        <div class="flex items-center justify-between">
          <div>
            <h2 class="text-2xl md:text-3xl font-extrabold">Contracts</h2>
            <p class="text-sm text-gray-400">Create, send and track signatures</p>
          </div>
          <button id="openContractModal" class="btn-main px-4 py-2 rounded-xl font-bold flex items-center gap-2">
            <span class="material-icons">note_add</span> Create Contract
          </button>
        </div>
        <div class="glass p-4 md:p-5 rounded-2xl">
          <h3 class="text-lg md:text-xl font-bold mb-2 md:mb-3">Contract History</h3>
          <div id="contractList" class="grid gap-3"></div>
        </div>
      </section>
    </main>
  </div>

  <!-- Add/Edit Model Modal -->
  <div id="modelFormModal" class="fixed inset-0 hidden items-center justify-center p-6 z-30">
    <div class="absolute inset-0 bg-black/60" id="modelFormBackdrop"></div>
    <div class="relative glass rounded-2xl w-full max-w-5xl max-h-[90vh] overflow-y-auto">
      <form id="modelForm" class="p-6 grid grid-cols-1 md:grid-cols-2 gap-5">
        <input type="hidden" id="modelId"/>
        <div class="md:col-span-2 flex items-center justify-between">
            <h3 id="formTitle" class="text-xl font-bold">New Model Information</h3>
            <button type="button" id="closeModelForm" class="text-gray-300 hover:text-white text-3xl leading-none">&times;</button>
        </div>

        <label class="block"><span class="block text-sm mb-1">Full Name</span><input id="fullName" required class="w-full rounded-xl bg-white/5 border border-white/10 px-3 py-2"/></label>
        <label class="block"><span class="block text-sm mb-1">Phone Number</span><input id="phoneNumber" class="w-full rounded-xl bg-white/5 border border-white/10 px-3 py-2"/></label>
        <label class="block"><span class="block text-sm mb-1">Email Address</span><input id="email" type="email" required class="w-full rounded-xl bg-white/5 border border-white/10 px-3 py-2"/></label>
        <label class="block"><span class="block text-sm mb-1">Nationality</span><input id="nationality" class="w-full rounded-xl bg-white/5 border border-white/10 px-3 py-2"/></label>
        <label class="block"><span class="block text-sm mb-1">Languages Spoken</span><input id="languages" placeholder="English, Arabic" class="w-full rounded-xl bg-white/5 border border-white/10 px-3 py-2"/></label>
        <label class="block"><span class="block text-sm mb-1">Location (City/Emirate)</span><input id="location" class="w-full rounded-xl bg-white/5 border border-white/10 px-3 py-2"/></label>
        <label class="block"><span class="block text-sm mb-1">Height (cm)</span><input id="height" type="number" class="w-full rounded-xl bg-white/5 border border-white/10 px-3 py-2"/></label>
        <label class="block"><span class="block text-sm mb-1">Experience Level</span>
          <select id="experience" class="w-full rounded-xl bg-white/5 border border-white/10 px-3 py-2">
            <option>Beginner</option><option>Intermediate</option><option>Pro</option>
          </select>
        </label>
        <label class="block md:col-span-2"><span class="block text-sm mb-1">Previous Clients / Campaigns</span><textarea id="clients" rows="3" class="w-full rounded-xl bg-white/5 border border-white/10 px-3 py-2"></textarea></label>
        <label class="block md:col-span-2"><span class="block text-sm mb-1">Instagram or Portfolio Link</span><input id="portfolio" type="url" class="w-full rounded-xl bg-white/5 border border-white/10 px-3 py-2"/></label>

        <label class="block"><span class="block text-sm mb-1">Profile Photo</span><input id="profilePhoto" type="file" accept="image/*" class="w-full text-sm"/></label>
        <label class="block"><span class="block text-sm mb-1">Gallery (upload photos)</span><input id="galleryFiles" type="file" multiple accept="image/*" class="w-full text-sm"/></label>

        <div class="md:col-span-2">
          <span class="block text-sm mb-2">Willing to Wear</span>
          <div id="wearWrap" class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-6 gap-3"></div>
        </div>

        <h4 class="md:col-span-2 text-lg font-semibold pt-2">Internal & Financial</h4>
        <label class="block"><span class="block text-sm mb-1">Rate per Project/Day ($)</span><input id="rate" type="number" class="w-full rounded-xl bg-white/5 border border-white/10 px-3 py-2"/></label>
        <label class="block"><span class="block text-sm mb-1">Commission Split (%)</span><input id="commission" type="number" class="w-full rounded-xl bg-white/5 border border-white/10 px-3 py-2"/></label>
        <label class="block md:col-span-2"><span class="block text-sm mb-1">IBAN Number</span><input id="iban" class="w-full rounded-xl bg-white/5 border border-white/10 px-3 py-2"/></label>
        <label class="block md:col-span-2"><span class="block text-sm mb-1">Notes / Comments (Internal)</span><textarea id="notes" rows="3" class="w-full rounded-xl bg-white/5 border border-white/10 px-3 py-2"></textarea></label>

        <div class="md:col-span-2 flex items-center justify-end gap-3">
          <button type="button" id="cancelForm" class="rounded-xl px-4 py-2 bg-white/5 border border-white/10">Cancel</button>
          <button class="btn-main rounded-xl px-5 py-2 font-bold" id="saveModelBtn" type="submit">Save Model</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Model details modal -->
  <div id="modelModal" class="fixed inset-0 hidden items-center justify-center p-6 z-30">
    <div class="absolute inset-0 bg-black/60"></div>
    <div class="relative glass rounded-2xl w-full max-w-4xl p-6 max-h-[90vh] overflow-y-auto">
      <div class="flex items-start justify-between gap-4 mb-4">
        <h3 id="modalTitle" class="text-2xl font-bold"></h3>
        <button id="closeModelModal" class="text-gray-300 hover:text-white text-3xl leading-none">&times;</button>
      </div>
      <div id="modalBody" class="grid md:grid-cols-3 gap-6"></div>
    </div>
  </div>

  <!-- Create Contract modal -->
  <div id="contractModal" class="fixed inset-0 hidden items-center justify-center p-6 z-30">
    <div class="absolute inset-0 bg-black/60"></div>
    <div class="relative glass rounded-2xl w-full max-w-2xl p-6">
      <div class="flex items-start justify-between mb-3">
        <h3 class="text-2xl font-bold">New Contract</h3>
        <button id="closeContractModal" class="text-2xl leading-none text-gray-300 hover:text-white">&times;</button>
      </div>

      <div class="grid md:grid-cols-2 gap-5">
        <label class="block">
          <span class="block text-sm mb-1">Agency Representative</span>
          <input id="cRep" class="w-full rounded-xl bg-white/5 border border-white/10 px-3 py-2" placeholder="Your name" required/>
        </label>

        <label class="block">
          <span class="block text-sm mb-1">Model</span>
          <input id="cModel" list="modelNames" class="w-full rounded-xl bg-white/5 border border-white/10 px-3 py-2" placeholder="Start typing a model name…" required/>
          <datalist id="modelNames"></datalist>
        </label>

        <label class="block">
          <span class="block text-sm mb-1">Date</span>
          <input id="cDate" type="date" class="w-full rounded-xl bg-white/5 border border-white/10 px-3 py-2"/>
        </label>

        <label class="block">
          <span class="block text-sm mb-1">Amount ($)</span>
          <input id="cAmount" type="number" class="w-full rounded-xl bg-white/5 border border-white/10 px-3 py-2" value="0"/>
        </label>

        <label class="block">
          <span class="block text-sm mb-1">Commission Split (%)</span>
          <input id="cCommission" type="number" class="w-full rounded-xl bg-white/5 border border-white/10 px-3 py-2" value="0"/>
        </label>
      </div>

      <div class="mt-5">
        <div class="flex items-center justify-between mb-2">
          <h4 class="text-lg font-semibold">Admin Signature</h4>
          <label class="text-[13px] text-blue-300 hover:text-blue-200 cursor-pointer">
            Upload signature <input id="adminUpload" type="file" accept="image/png,image/jpeg" class="hidden">
          </label>
        </div>
        <div class="bg-white/5 border border-white/10 rounded-xl p-3">
          <canvas id="adminPad" class="w-full h-40"></canvas>
        </div>
        <div class="flex items-center justify-between mt-3">
          <label class="flex items-center gap-2 text-sm">
            <input id="adminSigConfirm" type="checkbox" class="accent-[var(--vdm-yellow)]">
            <span>I confirm this is my signature.</span>
          </label>
          <div class="flex items-center gap-2">
            <button id="clearAdminSig" class="rounded-xl px-4 py-2 bg-white/5 border border-white/10">Clear</button>
            <button id="createContract" class="btn-main rounded-xl px-5 py-2 font-bold disabled:opacity-60 disabled:cursor-not-allowed" disabled>
              Generate Signing Link
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Link modal -->
  <div id="linkModal" class="fixed inset-0 hidden items-center justify-center p-6 z-30">
    <div class="absolute inset-0 bg-black/60"></div>
    <div class="relative glass rounded-2xl w-full max-w-lg p-6">
      <h3 class="text-2xl font-bold mb-2">Model Signing Link</h3>
      <p class="text-sm text-gray-400 mb-3">Share this secure link with the model.</p>
      <div class="relative bg-white/5 border border-white/10 rounded-xl">
        <input id="modelLink" readonly class="w-full bg-transparent px-3 py-3"/>
        <button id="copyLink" class="btn-main absolute right-2 top-1/2 -translate-y-1/2 rounded-lg px-3 py-1">Copy</button>
      </div>
      <div class="text-right mt-4"><button id="closeLink" class="rounded-xl px-4 py-2 bg-white/5 border border-white/10">Done</button></div>
    </div>
  </div>

  <!-- Toast -->
  <div id="toast" class="fixed bottom-6 right-6 hidden z-40"></div>

  <!-- Firebase (modular v12) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
    import {
      getFirestore, collection, doc, getDocs, addDoc, setDoc, deleteDoc,
      onSnapshot, query, where, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

    // Firebase Config
    const firebaseConfig = {
      apiKey: "AIzaSyBl-_h0gZvIwKqudXq-Tj4X3O9PzVYml3A",
      authDomain: "viraldosemodels.firebaseapp.com",
      projectId: "viraldosemodels",
      storageBucket: "viraldosemodels.firebasestorage.app",
      messagingSenderId: "1067901876974",
      appId: "1:1067901876974:web:28e63a8fda4224967c91ff"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getFirestore(app);
    const { jsPDF } = window.jspdf; // Get jsPDF from global scope

    // Collections
    const colModels    = () => collection(db, "models");
    const colContracts = () => collection(db, "contracts");
    const colLogs      = () => collection(db, "logs");
    const colVisits    = () => collection(db, "visits");

    // Helpers
    const $  = (s, r=document) => r.querySelector(s);
    const $$ = (s, r=document) => [...r.querySelectorAll(s)];
    const toast = (msg, type='success') => {
      const el = $('#toast');
      el.className = `fixed bottom-6 right-6 glass rounded-xl px-4 py-3 text-sm z-40 ${type==='error'?'border-red-400/40 text-red-200':'border-white/10'}`;
      el.textContent = msg; el.style.display = 'block';
      setTimeout(()=>{ el.style.display='none'; }, 2200);
    };

    const fileToBase64 = file => new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = () => resolve(reader.result);
        reader.onerror = error => reject(error);
    });


    // Sidebar hover logic
    const sidebar = $('#sidebar');
    sidebar.addEventListener('mouseenter', () => document.body.classList.remove('sidebar-collapsed'));
    sidebar.addEventListener('mouseleave', () => document.body.classList.add('sidebar-collapsed'));

    // Auth gate
    onAuthStateChanged(auth, (user) => {
      if (!user) { window.location.href = 'login.html'; return; }
      startApp();
    });
    $('#logout-btn')?.addEventListener('click', async ()=>{ await signOut(auth); sessionStorage.removeItem('user'); window.location.href='login.html'; });

    // Page Navigation
    const sections = { 'dashboard-page': $('#dashboard-page'), 'models-page': $('#models-page'), 'contracts-page': $('#contracts-page') };
    $$('.nav-link').forEach(a => a.addEventListener('click', (e)=>{
      e.preventDefault();
      const target = a.dataset.target;
      Object.values(sections).forEach(s => s.classList.add('hidden'));
      sections[target].classList.remove('hidden');
      $$('.nav-link').forEach(x=>x.classList.remove('nav-active'));
      a.classList.add('nav-active');
    }));

    // Wear options
    const wearOptions = ['Traditional','Casual','Glamour','Swimwear','Lingerie'];
    const wearWrap = $('#wearWrap');
    wearWrap.innerHTML = wearOptions.map(w => `
      <label class="flex items-center gap-2 bg-white/5 border border-white/10 rounded-xl px-3 py-2 cursor-pointer">
        <input type="checkbox" value="${w}" class="accent-[var(--vdm-yellow)]"> <span>${w}</span>
      </label>
    `).join('');

    // Model Form Modal Logic
    const modelFormModal = $('#modelFormModal');
    const openModelForm = () => {
        modelFormModal.classList.remove('hidden');
        modelFormModal.classList.add('flex');
    }
    const closeModelForm = () => {
        modelFormModal.classList.add('hidden');
        modelFormModal.classList.remove('flex');
        resetForm();
    }

    $('#addModelBtn').addEventListener('click', () => {
      resetForm();
      openModelForm();
    });
    $('#closeModelForm').addEventListener('click', closeModelForm);
    $('#cancelForm').addEventListener('click', closeModelForm);
    $('#modelFormBackdrop').addEventListener('click', closeModelForm);


    // Search
    $('#searchModel').addEventListener('input', (e)=> renderModelGrid(e.target.value.trim().toLowerCase()));

    // State
    let models = [];
    let contractsCache = [];
    let chart;

    $('#modelForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const saveBtn = $('#saveModelBtn');
      saveBtn.disabled = true;
      saveBtn.textContent = 'Saving...';

      const id = $('#modelId').value || null;
      const form_data = readModelForm();

      if (!form_data.fullName) {
        toast('Full name is required', 'error');
        saveBtn.disabled = false;
        saveBtn.textContent = id ? 'Update Model' : 'Save Model';
        return;
      }

      try {
        const existing_model = id ? models.find(m => m.id === id) : {};
        let final_data = { ...existing_model, ...form_data };
        
        const profileFile = $('#profilePhoto').files?.[0];
        if (profileFile) {
          final_data.profilePhotoB64 = await fileToBase64(profileFile);
        }

        const galleryFiles = $('#galleryFiles').files ? [...$('#galleryFiles').files] : [];
        if (galleryFiles.length > 0) {
            const newGalleryB64 = await Promise.all(galleryFiles.map(fileToBase64));
            const existingGallery = final_data.galleryB64 || [];
            final_data.galleryB64 = [...existingGallery, ...newGalleryB64];
        }

        const docRef = id ? doc(db, 'models', id) : doc(colModels());
        await setDoc(docRef, final_data, { merge: true });
        
        await addLog(`${id ? 'Updated' : 'Added'} model: ${final_data.fullName}`);
        await loadModels();
        closeModelForm();
        toast(`Model ${id ? 'updated' : 'saved'} successfully`);

      } catch (err) {
        console.error("Save/Update Error:", err);
        toast('Failed to save model', 'error');
      } finally {
        saveBtn.disabled = false;
        saveBtn.textContent = 'Save Model';
      }
    });


    function readModelForm(){
      const wear = [...wearWrap.querySelectorAll('input:checked')].map(x=>x.value);
      return {
        fullName: $('#fullName').value.trim(),
        phoneNumber: $('#phoneNumber').value.trim(),
        email: $('#email').value.trim(),
        nationality: $('#nationality').value.trim(),
        languages: $('#languages').value.trim(),
        location: $('#location').value.trim(),
        height: $('#height').value.trim(),
        experience: $('#experience').value,
        clients: $('#clients').value.trim(),
        portfolio: $('#portfolio').value.trim(),
        willingToWear: wear,
        rate: Number($('#rate').value || 0),
        commission: Number($('#commission').value || 0),
        iban: $('#iban').value.trim(),
        notes: $('#notes').value.trim(),
      };
    }
    function resetForm(){
      $('#modelForm').reset();
      $('#modelId').value='';
      $('#formTitle').textContent='New Model Information';
      wearWrap.querySelectorAll('input').forEach(i=>i.checked=false);
      $('#saveModelBtn').textContent = 'Save Model';
    }

    async function loadModels(){
      const snap = await getDocs(colModels());
      models = snap.docs.map(d=>({ id:d.id, ...d.data() }));
      $('#statModels').textContent = String(models.length);
      renderModelGrid($('#searchModel').value.trim().toLowerCase());

      const dl = $('#modelNames'); dl.innerHTML = '';
      models.forEach(m => { const o = document.createElement('option'); o.value = m.fullName || ''; dl.appendChild(o); });
    }

    function renderModelGrid(filter=''){
      const grid = $('#modelGrid'); grid.innerHTML='';
      const filtered = models.filter(m => (m.fullName||'').toLowerCase().includes(filter));
      for (const m of filtered){
        const card = document.createElement('div');
        card.className = 'relative overflow-hidden rounded-2xl glass hover-float cursor-pointer group';
        const img = m.profilePhotoB64 || `https://placehold.co/600x800/1f1f28/FFFFFF?text=${encodeURIComponent(m.fullName?.charAt(0)||'M')}`;
        card.innerHTML = `
          <div class="h-64 w-full overflow-hidden">
            <img src="${img}" class="h-full w-full object-cover group-hover:scale-[1.03] transition-transform"/>
          </div>
          <div class="p-4">
            <div class="flex items-center justify-between">
              <div>
                <h4 class="text-lg font-bold">${m.fullName||'Unnamed'}</h4>
                <p class="text-xs text-gray-400">${m.experience||'N/A'} · ${m.location||'—'}</p>
              </div>
              <button class="rounded-lg px-3 py-1 text-sm" style="background:var(--vdm-yellow); color:#111">Details</button>
            </div>
          </div>`;
        card.addEventListener('click', ()=>openModelModal(m));
        grid.appendChild(card);
      }
    }

    // Model details modal
    const modelModal = $('#modelModal');
    function openModelModal(m){
      $('#modalTitle').textContent = m.fullName || 'Model';
      const body = $('#modalBody');

      const galleryHtml = (m.galleryB64||[]).slice(0,10).map(u=>`<img src="${u}" class="h-24 w-full object-cover rounded-xl border border-white/10">`).join('');

      body.innerHTML = `
        <div>
          <img src="${m.profilePhotoB64||'https://placehold.co/600x800/1f1f28/FFFFFF?text=Image'}" class="rounded-xl border border-white/10 w-full object-cover max-h-[420px]"/>
          <div class="flex gap-2 mt-3">
            <button id="editModelBtn" class="px-3 py-2 rounded-lg bg-white/5 border border-white/10">Edit</button>
            <button id="deleteModelBtn" class="px-3 py-2 rounded-lg border border-red-500/40 text-red-300">Delete</button>
          </div>
        </div>
        <div class="md:col-span-2 space-y-4">
          <div class="grid sm:grid-cols-2 gap-3 text-sm">
            <div><span class="text-gray-400">Nationality</span><div>${m.nationality||'—'}</div></div>
            <div><span class="text-gray-400">Location</span><div>${m.location||'—'}</div></div>
            <div><span class="text-gray-400">Height</span><div>${m.height?m.height+' cm':'—'}</div></div>
            <div><span class="text-gray-400">Experience</span><div>${m.experience||'—'}</div></div>
            <div><span class="text-gray-400">Languages</span><div>${m.languages||'—'}</div></div>
            <div><span class="text-gray-400">Phone</span><div>${m.phoneNumber||'—'}</div></div>
            <div class="sm:col-span-2"><span class="text-gray-400">Email</span><div>${m.email||'—'}</div></div>
            <div class="sm:col-span-2"><span class="text-gray-400">Portfolio</span><div><a class="text-blue-300 hover:underline" target="_blank" href="${m.portfolio||'#'}">${m.portfolio||'—'}</a></div></div>
            <div class="sm:col-span-2"><span class="text-gray-400">Wears</span><div>${(m.willingToWear||[]).join(', ')||'—'}</div></div>
          </div>
          <h4 class="text-lg font-semibold pt-2">Internal</h4>
          <div class="grid sm:grid-cols-2 gap-3 text-sm">
            <div><span class="text-gray-400">Rate</span><div>${m.rate?`$${m.rate}/day`:'—'}</div></div>
            <div><span class="text-gray-400">Commission</span><div>${m.commission?m.commission+'%':'—'}</div></div>
            <div class="sm:col-span-2"><span class="text-gray-400">IBAN</span><div class="break-all">${m.iban||'—'}</div></div>
            <div class="sm:col-span-2"><span class="text-gray-400">Notes</span><div class="whitespace-pre-wrap">${m.notes||'—'}</div></div>
          </div>
          <h4 class="text-lg font-semibold pt-2">Gallery</h4>
          <div class="grid grid-cols-3 gap-2">${galleryHtml||'<div class="text-sm text-gray-500">No gallery</div>'}</div>
        </div>`;

      $('#editModelBtn').onclick = ()=>{
        closeModelModal();
        resetForm();
        $('#modelId').value = m.id;
        $('#formTitle').textContent = `Editing: ${m.fullName}`;
        $('#saveModelBtn').textContent='Update Model';
        ['fullName','phoneNumber','email','nationality','languages','location','height','experience','clients','portfolio','rate','commission','iban','notes']
          .forEach(k=>{ const el=$('#'+k); if(el) el.value = m[k]??'' });
        wearWrap.querySelectorAll('input').forEach(cb=> cb.checked = (m.willingToWear||[]).includes(cb.value));
        openModelForm();
      };
      $('#deleteModelBtn').onclick = async ()=>{
        if (confirm(`Delete ${m.fullName}?`)) {
          await deleteDoc(doc(db, 'models', m.id));
          await addLog(`Deleted model: ${m.fullName}`);
          await loadModels();
          closeModelModal();
        }
      };

      modelModal.classList.remove('hidden'); modelModal.classList.add('flex');
    }
    const closeModelModal = ()=>{ modelModal.classList.add('hidden'); modelModal.classList.remove('flex'); };
    $('#closeModelModal').addEventListener('click', closeModelModal);
    modelModal.addEventListener('click', (e)=>{ if(e.target===modelModal) closeModelModal(); });

    // Logs
    async function addLog(message){
      const userEmail = (JSON.parse(sessionStorage.getItem('user')||'{}').email)||'Admin';
      await addDoc(colLogs(), { message, user:userEmail, timestamp: serverTimestamp() });
    }
    function renderLogs(list){
      const el = $('#logs'); el.innerHTML='';
      for (const l of list){
        const d = l.timestamp?.toDate?.() || new Date();
        const row = document.createElement('div'); row.className = 'flex items-start gap-3';
        row.innerHTML = `<div class="w-2 h-2 rounded-full mt-1.5" style="background:var(--vdm-yellow)"></div>
          <div><div class="text-sm">${l.message}</div><div class="text-[11px] text-gray-400">${d.toLocaleString()}</div></div>`;
        el.appendChild(row);
      }
    }
    onSnapshot(query(colLogs(), where('timestamp','!=',null)), (snap)=>{
      const arr = snap.docs.map(d=>d.data()).sort((a,b)=> (b.timestamp?.toMillis?.()||0)-(a.timestamp?.toMillis?.()||0));
      renderLogs(arr);
    });

    // Contracts
    onSnapshot(query(colContracts()), (snap)=>{
      const list = snap.docs.map(d=>({ id:d.id, ...d.data() }))
                    .sort((a,b)=> (b.createdAt?.toMillis?.()||0)-(a.createdAt?.toMillis?.()||0));
      contractsCache = list;
      renderContracts(list);
      updateMetricsFromContracts(list);
      list.forEach(async c=>{
        if ((c.status||'').startsWith('Signed') && !c.signedLogged){
          try {
            await addLog(`Signed contract: ${c.modelName}`);
            await setDoc(doc(db,'contracts',c.id), { signedLogged:true }, {merge: true});
          } catch(e) {}
        }
      });
    });

    function renderContracts(data){
      const wrap = $('#contractList'); wrap.innerHTML='';
      for (const c of data){
        const row = document.createElement('div'); row.className='glass rounded-xl p-4 flex items-center justify-between';
        const signed = (c.status||'').startsWith('Signed');
        const downloadButtonHtml = signed
            ? `<button data-contract-id="${c.id}" class="download-pdf-btn px-3 py-2 rounded-lg text-sm" style="background:var(--vdm-yellow); color:#111">Download PDF</button>` 
            : '';

        row.innerHTML = `
          <div>
            <div class="font-semibold">${c.modelName}</div>
            <div class="text-sm text-gray-400">By ${c.agencyRepresentative} • ${c.contractDate} • ${c.amount?`$${c.amount}`:'$0'} • ${c.commission??0}%</div>
            <div class="text-[12px] ${signed?'text-green-300':'text-yellow-300'}">${c.status||'—'}</div>
          </div>
          <div class="flex items-center gap-2">
            <a href="contract.html?contractId=${c.id}" target="_blank" class="px-3 py-2 rounded-lg bg-white/5 border border-white/10 text-sm">View</a>
            ${downloadButtonHtml}
          </div>`;
        wrap.appendChild(row);
      }
      
      $$('.download-pdf-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
            const contractId = e.target.dataset.contractId;
            const contractData = contractsCache.find(con => con.id === contractId);
            if (contractData) {
                generateAndDownloadPdf(contractData);
            }
        });
      });
    }

    // Chart & Metrics
    function ensureChart(){
      if (chart) return chart;
      const ctx = document.getElementById('mainChart').getContext('2d');
      chart = new Chart(ctx, {
        type:'line',
        data:{ labels:[], datasets:[{label:'Revenue', data:[], tension:.35, borderColor: 'var(--vdm-yellow)', backgroundColor: 'rgba(255,229,0,.15)', fill: true}] },
        options:{
          responsive:true, maintainAspectRatio:false,
          plugins:{ legend:{display:false} },
          scales:{ x:{ticks:{color:'#bdbdc7'}, grid: { color: 'rgba(255,255,255,0.05)' }}, y:{ticks:{color:'#bdbdc7'}, grid: { color: 'rgba(255,255,255,0.05)'}} }
        }
      });
      return chart;
    }
    function updateMetricsFromContracts(list){
      const signed = list.filter(c=> (c.status||'').startsWith('Signed'));
      const revenue = signed.reduce((s,c)=> s + Number(c.amount||0), 0);
      const profit  = signed.reduce((s,c)=> s + Number(c.amount||0) * (Number(c.commission||0)/100), 0);
      $('#statRevenue').textContent = `$${revenue.toLocaleString()}`;
      $('#statProfit').textContent  = `$${profit.toLocaleString()}`;

      const days = Number($('#rangeSelect').value);
      const metric = $('#chartType').value;
      const byDay = new Map();
      for (const c of signed){
        const d = new Date(c.contractDate||Date.now()); d.setHours(0,0,0,0);
        if (days && ((Date.now()-d.getTime())/86400000) > days) continue;
        const k = d.toISOString().slice(0,10);
        const val = metric==='profit' ? Number(c.amount||0)*(Number(c.commission||0)/100) : Number(c.amount||0);
        byDay.set(k, (byDay.get(k)||0) + val);
      }
      const labels = [...byDay.keys()].sort();
      const values = labels.map(k=> byDay.get(k));
      const ch = ensureChart();
      ch.data.labels = labels;
      ch.data.datasets[0].label = metric==='profit' ? 'Profit' : 'Revenue';
      ch.data.datasets[0].data  = values;
      ch.update();
      $('#chartTitle').textContent = ch.data.datasets[0].label;
    }
    $('#chartType').addEventListener('change', ()=> updateMetricsFromContracts(contractsCache));
    $('#rangeSelect').addEventListener('change', ()=> updateMetricsFromContracts(contractsCache));

    // Daily visitors
    function uuid(){ return crypto.randomUUID?.() || Math.random().toString(36).slice(2); }
    async function trackVisit(){
      let sid = localStorage.getItem('vdm_session'); if(!sid){ sid = uuid(); localStorage.setItem('vdm_session', sid); }
      await setDoc(doc(colVisits(), sid), { ts: serverTimestamp() }, {merge: true});
      onSnapshot(colVisits(), (snap) => {
        const cutoff = Date.now() - 24*3600*1000;
        let count = 0;
        snap.docs.forEach(d=>{
          const t=d.data().ts?.toDate?.()?.getTime?.()||0;
          if (t > cutoff) count++;
        });
        $('#statVisitors').textContent = String(count);
      });
    }

    // Contract Creation
    let adminPad, adminSigDataURL = '';
    const contractModal = $('#contractModal');
    const createBtn = $('#createContract');

    function scaleCanvasToDPR(canvas, padInstance) {
        const ratio = Math.max(window.devicePixelRatio || 1, 1);
        const rect = canvas.getBoundingClientRect();
        canvas.width  = Math.floor(rect.width  * ratio);
        canvas.height = Math.floor(rect.height * ratio);
        const ctx = canvas.getContext('2d');
        ctx.scale(ratio, ratio);
        if (padInstance) {
            padInstance.clear();
        }
    }

    function openContractModal(){
      $('#cDate').value = new Date().toISOString().slice(0,10);
      $('#cAmount').value = 0; $('#cCommission').value = 0;
      $('#adminSigConfirm').checked = false; adminSigDataURL = '';
      contractModal.classList.remove('hidden'); contractModal.classList.add('flex');
      initPad();
      refreshCreateButton();
    }
    function closeContractModal(){
      contractModal.classList.add('hidden'); contractModal.classList.remove('flex');
      if(adminPad) adminPad.off(); // Clean up listeners
      adminPad = null;
    }
    function initPad(){
      const c = $('#adminPad');
      adminPad = new SignaturePad(c, {
          penColor: '#000000',
          backgroundColor: '#ffffff'
      });
      scaleCanvasToDPR(c, adminPad);

      $('#clearAdminSig').onclick = ()=>{ adminPad.clear(); adminSigDataURL=''; refreshCreateButton(); };
      c.addEventListener('pointerup', ()=>{ adminSigDataURL=''; refreshCreateButton(); });
    }
    function refreshCreateButton(){
      const valid = ($('#cRep').value.trim() && $('#cModel').value.trim() && $('#cDate').value) &&
                    ($('#adminSigConfirm').checked) &&
                    (!adminPad?.isEmpty() || !!adminSigDataURL);
      createBtn.disabled = !valid;
    }
    $('#openContractModal').addEventListener('click', openContractModal);
    $('#closeContractModal').addEventListener('click', closeContractModal);
    $('#cRep').addEventListener('input', refreshCreateButton);
    $('#cModel').addEventListener('input', (e)=>{
      const m = models.find(x => (x.fullName||'').toLowerCase() === e.target.value.trim().toLowerCase());
      if (m && typeof m.commission !== 'undefined') $('#cCommission').value = Number(m.commission||0);
      refreshCreateButton();
    });
    $('#cDate').addEventListener('change', refreshCreateButton);
    $('#adminSigConfirm').addEventListener('change', refreshCreateButton);
    $('#adminUpload').addEventListener('change', async (e)=>{
      const f = e.target.files?.[0]; if(!f) return;
      const b64 = await fileToBase64(f);
      adminSigDataURL = b64; 
      if(adminPad) {
        adminPad.clear();
        adminPad.fromDataURL(b64, {width: adminPad.canvas.width, height: adminPad.canvas.height});
      }
      toast('Signature uploaded'); 
      refreshCreateButton();
    });

    $('#createContract').addEventListener('click', async ()=>{
      try {
        const rep = $('#cRep').value.trim();
        const modelName = $('#cModel').value.trim();
        const date = $('#cDate').value;
        const amount = Number($('#cAmount').value||0);
        const commission = Number($('#cCommission').value||0);
        let sigData = adminSigDataURL || adminPad.toDataURL();

        const payload = {
          agencyRepresentative: rep, modelName, contractDate: date, amount, commission,
          adminSignature: sigData, status: 'Awaiting Model Signature', createdAt: serverTimestamp()
        };
        const ref = await addDoc(colContracts(), payload);
        await addLog(`Created contract for ${modelName}`);

        const base = `${location.origin}${location.pathname.replace('ModelArea.html','')}contract.html`;
        const link = `${base}?contractId=${ref.id}`;

        closeContractModal();
        $('#modelLink').value = link;
        openLinkModal();
      } catch (err) {
        console.error(err);
        toast('Failed to create contract','error');
      }
    });

    // Link modal
    const linkModal = $('#linkModal');
    function openLinkModal(){ linkModal.classList.remove('hidden'); linkModal.classList.add('flex'); }
    function closeLinkModal(){ linkModal.classList.add('hidden'); linkModal.classList.remove('flex'); }
    $('#closeLink').addEventListener('click', closeLinkModal);
    $('#copyLink').addEventListener('click', async ()=>{ await navigator.clipboard.writeText($('#modelLink').value); toast('Link copied'); });

    // --- FIX: On-demand PDF Generation for Admin ---
    const contractTerms = [
            "1. Parties Involved: This Agreement is between VD Smedia, a marketing agency based in the UAE, and the individual model named below.",
            "2. Scope of Work: The Model agrees to participate in photo and/or video shoots as arranged by VD Smedia for its clients' content marketing needs.",
            "3. Usage Rights: The Model grants VD Smedia and its clients perpetual, worldwide, and unrestricted rights to use all produced content for any purpose, including commercial, advertising, editorial, and social media, without any time limit.",
            "4. Compensation: The Model shall be compensated as agreed upon before each project. Payment details will be specified per project basis.",
            "5. Work Schedule & Deliverables: The shoot schedule, location, and expectations will be communicated and agreed upon before each session.",
            "6. Confidentiality Clause: The Model agrees to keep all information related to the shoot, client, project, or content strictly confidential. The Model shall not disclose or share any behind-the-scenes content or final deliverables on social media or elsewhere unless written permission is provided by VD Smedia.",
            "7. Content Ownership: All content created during the shoot shall remain the sole property of VD Smedia and/or its clients. The Model waives any rights, claims, or approvals over the content.",
            "8. Model Release: The Model grants full rights to be photographed and/or recorded and waives any right to inspect or approve the final content.",
            "9. Code of Conduct: The Model agrees to behave professionally, arrive on time, and follow reasonable directions provided during the shoot.",
            "10. Termination Clause: VD Smedia may terminate this agreement at any time if the Model breaches any of its terms, including failure to appear, unprofessional conduct, or violation of confidentiality.",
            "11. Legal & Jurisdiction: This Agreement shall be governed by the laws of the United Arab Emirates. Any disputes shall be settled in a court of competent jurisdiction in the UAE.",
            "12. Signatures: By signing below, both parties agree to the terms and conditions of this agreement."
        ];

    function generateAndDownloadPdf(contract) {
        const doc = new jsPDF();
        doc.setFontSize(18);
        doc.setFont('helvetica', 'bold');
        doc.text("Model Agreement - VD Smedia", 105, 20, { align: 'center' });
        
        doc.setFontSize(10);
        doc.setFont('helvetica', 'normal');
        doc.text(`This Model Agreement ("Agreement") is made between VD Smedia ("Agency") and the undersigned model ("Model") as of the date of signing.`, 20, 35, { maxWidth: 170 });
        
        doc.text(contractTerms.map(t => t).join('\n\n'), 20, 50, { maxWidth: 170 });
        
        let finalY = 230;

        // Column 1
        doc.text("Model Name:", 20, finalY);
        doc.text(contract.modelName, 20, finalY + 5);
        if (contract.modelSignature) {
            doc.addImage(contract.modelSignature, 'PNG', 20, finalY + 10, 60, 15);
        }
        doc.text("Model Signature:", 20, finalY + 30);
        doc.text(`Date: ${contract.contractDate}`, 20, finalY + 35);


        // Column 2
        doc.text("Agency Representative (VD Smedia):", 110, finalY);
        doc.text(contract.agencyRepresentative, 110, finalY + 5);
        if (contract.adminSignature) {
            doc.addImage(contract.adminSignature, 'PNG', 110, finalY + 10, 60, 15);
        }
        doc.text("Agency Signature:", 110, finalY + 30);
        doc.text(`Date: ${contract.contractDate}`, 110, finalY + 35);
        
        doc.save(`Signed-Contract-${contract.modelName.replace(/\s/g, '_')}.pdf`);
    }


    // START
    async function startApp(){
      await trackVisit();
      await loadModels();
    }
  </script>
</body>
</html>
